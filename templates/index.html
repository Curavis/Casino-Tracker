<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Casino Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* DARK THEME & CENTERING */
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 40px;
            background-color: #121212; /* Very dark gray background */
            color: #e0e0e0; /* Light text color */
            text-align: center; /* Center everything by default */
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; /* Center container horizontally */
            background: #1e1e1e; /* Darker container background */
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.5); /* Stronger shadow for depth */
        }
        h1, h2 { 
            text-align: center; 
            color: #ffffff;
        }

        /* DATA DISPLAY */
        .data-display { 
            margin: 20px 0 30px; 
            padding: 20px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            background-color: #2c2c2c;
        }
        .profit { 
            font-size: 2.8em; 
            font-weight: bold; 
            /* Color logic remains the same */
            color: {% if net_profit_f.startswith('-') %}#ff6b6b{% else %}#3fcf81{% endif %}; 
        } 

        /* NEW: WIN/LOSS BAR STYLES */
        .ratio-bar-container {
            width: 90%;
            height: 30px;
            background-color: #c0392b; /* Default loss color if 0 wins */
            border-radius: 4px;
            margin: 10px auto 10px;
            display: flex;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .win-bar {
            background-color: #27ae60; /* Win color */
            transition: width 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .loss-bar {
            background-color: #c0392b; /* Loss color */
            transition: width 0.5s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }


        /* CONTROLS (BUTTON ALIGNMENT FIX) */
        .controls { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .controls form { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 15px; /* Increased gap between button and input */
        }
        .controls button { 
            padding: 15px 30px; 
            font-size: 1.1em; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            width: 250px; /* Standardized width */
            transition: background-color 0.2s;
        }
        #lose-btn { 
            background-color: #c0392b; /* Darker red */
        } 
        #lose-btn:hover {
            background-color: #e74c3c;
        }
        #win-btn { 
            background-color: #27ae60;  /* Darker green */
        }
        #win-btn:hover {
            background-color: #2ecc71;
        }
        #winner-input { 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 4px; 
            width: 226px; 
            text-align: center;
            background-color: #333; /* Dark input background */
            color: #e0e0e0;
        }

        /* MESSAGES & LEADERBOARD */
        .clipboard-buttons button { 
            margin: 8px; 
            padding: 12px 18px; 
            background-color: #2980b9; 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clipboard-buttons button:hover {
            background-color: #3498db;
        }
        .leaderboard, .messages { 
            margin-top: 40px; 
            border-top: 1px solid #333; 
            padding-top: 20px; 
        }
        
        /* LEADERBOARD SCROLL FIX */
        .leaderboard-scroll {
            max-height: 200px; /* Adjust this height to control the size of the box */
            overflow-y: scroll; /* Forces the vertical scrollbar */
            overflow-x: hidden; /* Prevents unwanted horizontal scrollbar */
            padding-right: 10px; /* Adds space for the scrollbar */
            margin: 10px auto 0;
            text-align: left; /* Aligns the list items cleanly */
            background-color: #2c2c2c; /* Matches the li background */
            border-radius: 4px;
        }
        
        .leaderboard-scroll ul {
            list-style: none;
            padding-left: 10px; /* Adjust list padding inside the scrollbox */
            margin: 0; 
        }

        .leaderboard-scroll li {
            background-color: #2c2c2c; 
            margin: 2px 0;
            padding: 6px;
            border-radius: 4px;
            width: 95%; 
        }
        
        #copy-status { 
            margin-top: 10px; 
            font-weight: bold; 
            color: #aaa;
        }

        /* CHART SPECIFIC STYLES */
        .chart-container {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #333;
            max-width: 100%; /* Ensure it fits in container */
            height: 300px; /* Give it a fixed height */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spinning Wheel Game Tracker</h1>
        
        <div class="data-display">
            <h2>NET PROFIT: $<span class="profit">{{ net_profit_f }}</span></h2> 
            <p>TOTAL SPINS: <strong>{{ total_spins }}</strong> &bull; LOSS STREAK: <strong>{{ loss_streak }}</strong> SPINS</p>

            <p style="margin-top: 20px;">WIN/LOSS RATIO: <strong>{{ win_loss_display }}</strong></p>
            <div class="ratio-bar-container">
                {% if total_spins > 0 %}
                    <div class="win-bar" style="width: {{ win_percent }}%;">
                        {% if win_percent > 10 %}{{ win_percent }}%{% endif %}
                    </div>
                    <div class="loss-bar" style="width: {{ loss_percent }}%;">
                        {% if loss_percent > 10 %}{{ loss_percent }}%{% endif %}
                    </div>
                {% else %}
                    <div class="win-bar" style="width: 100%; background-color: #555;">
                        No Data Yet
                    </div>
                {% endif %}
            </div>
            
        </div>

        <div class="controls">
            <form method="POST" action="{{ url_for('player_loses_route') }}">
                <button type="submit" id="lose-btn">Player LOSES (+${{ bet_amount_f }}K)</button> 
            </form>
            
            <form method="POST" action="{{ url_for('player_wins_route') }}">
                <button type="submit" id="win-btn">Player WINS (-${{ net_casino_cost_f }}K)</button>
                <input type="text" name="winner_name" id="winner-input" placeholder="Winner's Name" required>
            </form>
        </div>

        <div class="messages">
            <h2>Quick Invite Copier</h2>
            <div class="clipboard-buttons">
                {% for key, message in messages.items() %}
                    {% set display_name = key %}
                    {% set message_content = message %}

                    {% if key == 'Loss Streak Alert' %}
                        {% set display_name = 'Loss Streak Message' %}
                        {% set message_content = loss_streak ~ ' losses in a row! Can\'t be much longer!' %}
                    {% endif %}

                    <button onclick="copyToClipboard('{{ message_content | e }}', '{{ display_name }}')">
                        Copy: {{ display_name }}
                    </button>
                {% endfor %}
            </div>
            <p id="copy-status">Ready to copy.</p>
        </div>

        <div class="leaderboard">
            <h2>All-Time Winners Leaderboard</h2>
            <div class="leaderboard-scroll">
                <ul>
                    {% for player, winnings_f in leaderboard_f %} 
                        <li>{{ loop.index }}. {{ player }}: ${{ winnings_f }}</li>
                    {% else %}
                        <li>No winners yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>Profit History</h2>
            <canvas id="profitChart"></canvas>
        </div>
        
    </div>

    <script>
        function copyToClipboard(text, key) {
            // FIX: Remove HTML escape characters like &quot; and &#39;
            text = text.replace(/&quot;/g, '"').replace(/&#39;/g, "'"); 

            const statusElement = document.getElementById('copy-status');
            
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            
            textarea.select();
            
            try {
                document.execCommand('copy');
                
                statusElement.textContent = `'${key}' Copied!`;
                statusElement.style.color = 'green';
            } catch (err) {
                console.error('Copy method failed: ', err);
                statusElement.textContent = 'ERROR: Copy failed.';
                statusElement.style.color = 'red';
            } finally {
                document.body.removeChild(textarea);

                setTimeout(() => {
                    statusElement.textContent = 'Ready to copy.';
                    statusElement.style.color = 'gray';
                }, 1500);
            }
        }
        
        // --- CHART.JS LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            // Get the profit history data passed from Flask
            const profitHistory = JSON.parse('{{ profit_history | tojson | safe }}');
            
            // Create labels (Spin 0, Spin 1, Spin 2, ...)
            const labels = profitHistory.map((_, index) => 'Spin ' + index);

            // Chart data structure
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Net Profit',
                    data: profitHistory,
                    borderColor: '#3498db', // Blue line color
                    backgroundColor: 'rgba(52, 152, 219, 0.2)', // Light blue area fill
                    fill: true,
                    tension: 0.1
                }]
            };

            // Chart configuration
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss ($)',
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333' // Darker grid lines
                            },
                            ticks: {
                                color: '#e0e0e0',
                                // Format ticks with commas and currency sign
                                callback: function(value, index, ticks) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff' // White legend text
                            }
                        }
                    }
                }
            };

            // Initialize and render the chart
            const ctx = document.getElementById('profitChart').getContext('2d');
            new Chart(ctx, config);
        });
    </script>
</body>
</html>
